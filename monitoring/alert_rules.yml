groups:
  - name: ai_opportunity_browser_alerts
    rules:
      # High-level service alerts
      - alert: HighErrorRate
        expr: rate(http_requests_total{status_code=~"5.."}[5m]) / rate(http_requests_total[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
          service: api
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }} for the last 5 minutes"
          runbook_url: "https://docs.example.com/runbooks/high-error-rate"

      - alert: HighResponseTime
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2.0
        for: 10m
        labels:
          severity: warning
          service: api
        annotations:
          summary: "High response time detected"
          description: "95th percentile response time is {{ $value }}s"
          runbook_url: "https://docs.example.com/runbooks/high-response-time"

      - alert: ServiceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
          service: "{{ $labels.job }}"
        annotations:
          summary: "Service is down"
          description: "{{ $labels.job }} service is down"
          runbook_url: "https://docs.example.com/runbooks/service-down"

      # Database alerts
      - alert: HighDatabaseConnections
        expr: db_connections_active > 80
        for: 5m
        labels:
          severity: warning
          service: database
        annotations:
          summary: "High database connection usage"
          description: "Database connections are at {{ $value }}, approaching limit"
          runbook_url: "https://docs.example.com/runbooks/high-db-connections"

      - alert: SlowDatabaseQueries
        expr: histogram_quantile(0.95, rate(db_query_duration_seconds_bucket[5m])) > 1.0
        for: 10m
        labels:
          severity: warning
          service: database
        annotations:
          summary: "Slow database queries detected"
          description: "95th percentile query time is {{ $value }}s"
          runbook_url: "https://docs.example.com/runbooks/slow-db-queries"

      # Agent system alerts
      - alert: AgentHighFailureRate
        expr: rate(agent_tasks_total{status="error"}[10m]) / rate(agent_tasks_total[10m]) > 0.10
        for: 15m
        labels:
          severity: critical
          service: agents
        annotations:
          summary: "High agent failure rate"
          description: "Agent {{ $labels.agent_type }} failure rate is {{ $value | humanizePercentage }}"
          runbook_url: "https://docs.example.com/runbooks/agent-failures"

      - alert: AgentQueueBacklog
        expr: agent_queue_size > 1000
        for: 10m
        labels:
          severity: warning
          service: agents
        annotations:
          summary: "Agent queue backlog"
          description: "Agent {{ $labels.agent_type }} queue size is {{ $value }}"
          runbook_url: "https://docs.example.com/runbooks/agent-queue-backlog"

      - alert: AgentTaskTimeout
        expr: histogram_quantile(0.95, rate(agent_task_duration_seconds_bucket[10m])) > 1800
        for: 15m
        labels:
          severity: warning
          service: agents
        annotations:
          summary: "Agent tasks taking too long"
          description: "95th percentile task duration for {{ $labels.agent_type }} is {{ $value }}s"
          runbook_url: "https://docs.example.com/runbooks/agent-timeouts"

      # Cache alerts
      - alert: LowCacheHitRate
        expr: cache_hits_total / (cache_hits_total + cache_misses_total) < 0.80
        for: 15m
        labels:
          severity: warning
          service: cache
        annotations:
          summary: "Low cache hit rate"
          description: "Cache hit rate for {{ $labels.cache_type }} is {{ $value | humanizePercentage }}"
          runbook_url: "https://docs.example.com/runbooks/low-cache-hit-rate"

      - alert: CacheConnectionFailure
        expr: up{job="redis"} == 0
        for: 1m
        labels:
          severity: critical
          service: cache
        annotations:
          summary: "Cache service unavailable"
          description: "Redis cache is unavailable"
          runbook_url: "https://docs.example.com/runbooks/cache-down"

      # Business logic alerts
      - alert: LowOpportunityCreationRate
        expr: rate(opportunities_created_total[1h]) < 0.1
        for: 30m
        labels:
          severity: warning
          service: business
        annotations:
          summary: "Low opportunity creation rate"
          description: "Opportunity creation rate is {{ $value }} per hour"
          runbook_url: "https://docs.example.com/runbooks/low-opportunity-rate"

      - alert: ValidationBacklog
        expr: validations_submitted_total - opportunities_validated_total > 100
        for: 1h
        labels:
          severity: warning
          service: business
        annotations:
          summary: "Validation backlog building up"
          description: "{{ $value }} validations are pending"
          runbook_url: "https://docs.example.com/runbooks/validation-backlog"

      - alert: LowDataIngestionRate
        expr: rate(data_ingestion_rate_total[1h]) < 10
        for: 30m
        labels:
          severity: warning
          service: data_ingestion
        annotations:
          summary: "Low data ingestion rate"
          description: "Data ingestion rate is {{ $value }} items per hour from {{ $labels.source }}"
          runbook_url: "https://docs.example.com/runbooks/low-ingestion-rate"

      # AI Model alerts
      - alert: HighAIModelLatency
        expr: histogram_quantile(0.95, rate(ai_model_latency_seconds_bucket[10m])) > 30.0
        for: 10m
        labels:
          severity: warning
          service: ai_models
        annotations:
          summary: "High AI model latency"
          description: "95th percentile latency for {{ $labels.provider }}/{{ $labels.model }} is {{ $value }}s"
          runbook_url: "https://docs.example.com/runbooks/high-ai-latency"

      - alert: AIModelFailureRate
        expr: rate(ai_model_requests_total{result="error"}[10m]) / rate(ai_model_requests_total[10m]) > 0.05
        for: 10m
        labels:
          severity: warning
          service: ai_models
        annotations:
          summary: "High AI model failure rate"
          description: "Failure rate for {{ $labels.provider }}/{{ $labels.model }} is {{ $value | humanizePercentage }}"
          runbook_url: "https://docs.example.com/runbooks/ai-model-failures"

      # System resource alerts
      - alert: HighMemoryUsage
        expr: memory_usage_percent > 90
        for: 5m
        labels:
          severity: critical
          service: system
        annotations:
          summary: "High memory usage"
          description: "Memory usage is {{ $value }}%"
          runbook_url: "https://docs.example.com/runbooks/high-memory-usage"

      - alert: HighCPUUsage
        expr: cpu_usage_percent > 85
        for: 10m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "High CPU usage"
          description: "CPU usage is {{ $value }}%"
          runbook_url: "https://docs.example.com/runbooks/high-cpu-usage"

      - alert: DiskSpaceLow
        expr: disk_free_percent < 10
        for: 5m
        labels:
          severity: critical
          service: system
        annotations:
          summary: "Low disk space"
          description: "Disk space is {{ $value }}% free"
          runbook_url: "https://docs.example.com/runbooks/low-disk-space"

      # Vector database alerts
      - alert: VectorSearchLatency
        expr: histogram_quantile(0.95, rate(vector_search_latency_seconds_bucket[5m])) > 2.0
        for: 10m
        labels:
          severity: warning
          service: vector_db
        annotations:
          summary: "High vector search latency"
          description: "95th percentile vector search latency is {{ $value }}s"
          runbook_url: "https://docs.example.com/runbooks/vector-search-latency"

      - alert: VectorOperationFailures
        expr: rate(vector_operations_total{result="error"}[10m]) / rate(vector_operations_total[10m]) > 0.05
        for: 10m
        labels:
          severity: warning
          service: vector_db
        annotations:
          summary: "High vector operation failure rate"
          description: "Vector operation failure rate is {{ $value | humanizePercentage }}"
          runbook_url: "https://docs.example.com/runbooks/vector-operation-failures"

      # User experience alerts
      - alert: LowUserEngagement
        expr: rate(user_actions_total[1h]) < 10
        for: 1h
        labels:
          severity: info
          service: user_experience
        annotations:
          summary: "Low user engagement"
          description: "User action rate is {{ $value }} per hour"
          runbook_url: "https://docs.example.com/runbooks/low-user-engagement"

      - alert: HighUserSessionDropoff
        expr: rate(user_sessions_total[1h]) - rate(session_duration_seconds_count[1h]) > 0.3 * rate(user_sessions_total[1h])
        for: 30m
        labels:
          severity: warning
          service: user_experience
        annotations:
          summary: "High user session dropoff rate"
          description: "Session dropoff rate is high"
          runbook_url: "https://docs.example.com/runbooks/high-session-dropoff"

  - name: data_quality_alerts
    rules:
      - alert: LowDataQuality
        expr: histogram_quantile(0.50, rate(data_quality_score_bucket[1h])) < 0.6
        for: 1h
        labels:
          severity: warning
          service: data_quality
        annotations:
          summary: "Low data quality detected"
          description: "Median data quality score for {{ $labels.source }} is {{ $value }}"
          runbook_url: "https://docs.example.com/runbooks/low-data-quality"

      - alert: DataIngestionStalled
        expr: increase(data_ingestion_rate_total[30m]) == 0
        for: 30m
        labels:
          severity: critical
          service: data_ingestion
        annotations:
          summary: "Data ingestion has stalled"
          description: "No data ingested from {{ $labels.source }} in the last 30 minutes"
          runbook_url: "https://docs.example.com/runbooks/data-ingestion-stalled"

      - alert: HighDataProcessingTime
        expr: histogram_quantile(0.95, rate(data_processing_duration_seconds_bucket[10m])) > 300
        for: 15m
        labels:
          severity: warning
          service: data_processing
        annotations:
          summary: "High data processing time"
          description: "95th percentile processing time for {{ $labels.stage }} is {{ $value }}s"
          runbook_url: "https://docs.example.com/runbooks/high-processing-time"

  - name: security_alerts
    rules:
      - alert: UnusualAPIActivity
        expr: rate(http_requests_total[5m]) > 2 * rate(http_requests_total[1h] offset 1h)
        for: 10m
        labels:
          severity: warning
          service: security
        annotations:
          summary: "Unusual API activity detected"
          description: "API request rate is {{ $value }} times higher than usual"
          runbook_url: "https://docs.example.com/runbooks/unusual-api-activity"

      - alert: HighAuthenticationFailures
        expr: rate(http_requests_total{endpoint="/auth/login", status_code="401"}[10m]) > 10
        for: 5m
        labels:
          severity: warning
          service: security
        annotations:
          summary: "High authentication failure rate"
          description: "Authentication failure rate is {{ $value }} per minute"
          runbook_url: "https://docs.example.com/runbooks/high-auth-failures"

      - alert: SuspiciousUserBehavior
        expr: rate(user_actions_total{action_type="validation_submit"}[5m]) by (user_id) > 20
        for: 10m
        labels:
          severity: warning
          service: security
        annotations:
          summary: "Suspicious user behavior detected"
          description: "User {{ $labels.user_id }} is submitting validations at {{ $value }} per minute"
          runbook_url: "https://docs.example.com/runbooks/suspicious-user-behavior"